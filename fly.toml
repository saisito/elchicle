# fly.toml - Configuración de Fly.io para ElChicle Discord Bot
# Documentación: https://fly.io/docs/reference/configuration/

app = "elchicle"
primary_region = "mia" # Miami - cambiar a tu región preferida (mad para Madrid, ams para Amsterdam)

# Imagen Docker desde el Dockerfile del proyecto
[build]

# Variables de entorno - DEBES configurar los secretos con: fly secrets set
[env]
  NODE_ENV = "production"
  PORT = "3000"
  # Variables de yt-dlp para evitar detección de bot
  YT_DLP_USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
  YT_DLP_REFERER = "https://www.youtube.com/"
  # Variables del sistema
  PYTHONWARNINGS = "ignore"
  YTDL_NO_UPDATE = "1"
  YT_DLP_NO_UPDATE = "1"
  PYTHONIOENCODING = "utf-8"
  LANG = "C.UTF-8"
  LC_ALL = "C.UTF-8"
  # Variables anti-deprecación
  YT_DLP_NO_CALL_HOME = "false"
  YT_DLP_EXTRACT_FLAT = "false"
  YT_DLP_IGNORE_ERRORS = "true"
  YT_DLP_NO_WARNINGS = "true"
  YT_DLP_IGNORE_CONFIG = "true"
  YT_DLP_NO_CONFIG_LOCATIONS = "true"
  YT_DLP_SKIP_DOWNLOAD = "true"
  YT_DLP_QUIET = "true"
  YT_DLP_SIMULATE = "false"
  YT_DLP_FORCE_JSON = "true"
  YT_DLP_NO_PROGRESS = "true"
  YT_DLP_NO_COLOR = "true"

# Configuración HTTP para el health check
[[services]]
  internal_port = 3000
  protocol = "tcp"
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1

  # Health check endpoint
  [[services.http_checks]]
    interval = "30s"
    timeout = "10s"
    grace_period = "40s"
    method = "GET"
    path = "/health"

  [[services.ports]]
    port = 80
    handlers = ["http"]

  [[services.ports]]
    port = 443
    handlers = ["tls", "http"]

  # Configuración de conexiones TCP
  [[services.tcp_checks]]
    interval = "15s"
    timeout = "2s"
    grace_period = "1s"

# Configuración de recursos de la VM
[vm]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512

# Configuración de métricas
[metrics]
  port = 3000
  path = "/health"
